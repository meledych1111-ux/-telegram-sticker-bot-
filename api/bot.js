const { Telegraf } = require('telegraf');
const fetch = require('node-fetch');
const FormData = require('form-data');

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°
const bot = new Telegraf(process.env.BOT_TOKEN);

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.start((ctx) => {
  ctx.reply(
    'ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Ð±Ð¾Ñ‚ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÑ‚Ð¸ÐºÐµÑ€Ð¾Ð².\n\n' +
    'ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒ Ð¼Ð½Ðµ Ð»ÑŽÐ±Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ (PNG, JPEG, WebP), ' +
    'Ð¸ Ñ Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‰Ñƒ ÐµÐ³Ð¾ Ð² ÑÑ‚Ð¸ÐºÐµÑ€ Ð´Ð»Ñ Telegram!\n\n' +
    'ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒ Ð¼Ð½Ðµ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒÑŽ "ÑÑ‚Ð¸ÐºÐµÑ€" Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /sticker'
  );
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /help
bot.help((ctx) => {
  ctx.reply(
    'ðŸ“Œ ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°:\n\n' +
    '1. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒ Ð¼Ð½Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ (PNG, JPEG, WebP)\n' +
    '2. Ð¯ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÑŽ ÐµÐ³Ð¾ Ð² ÑÑ‚Ð¸ÐºÐµÑ€\n' +
    '3. Ð”Ð¾Ð±Ð°Ð²ÑŒ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð´Ð»Ñ ÑÑ‚Ð¸ÐºÐµÑ€Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)\n\n' +
    'âš ï¸ Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ðº Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼:\n' +
    'â€¢ Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°: Ð´Ð¾ 5 ÐœÐ‘\n' +
    'â€¢ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: PNG, JPEG, WebP\n' +
    'â€¢ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€: 512x512 Ð¿Ð¸ÐºÑÐµÐ»ÐµÐ¹\n\n' +
    'ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n' +
    '/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ\n' +
    '/help - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ\n' +
    '/sticker - Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÑ‚Ð¸ÐºÐµÑ€ Ð¸Ð· Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ'
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
bot.on('photo', async (ctx) => {
  try {
    const message = ctx.message;
    const photo = message.photo[message.photo.length - 1];
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð¸Ð· Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
    const emoji = message.caption || 'ðŸ˜€';
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ
    const processingMsg = await ctx.reply('ðŸ”„ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ...');
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
    const fileLink = await ctx.telegram.getFileLink(photo.file_id);
    
    // Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
    const response = await fetch(fileLink.href);
    const imageBuffer = await response.buffer();
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð¸ÐºÐµÑ€
    await createSticker(ctx, imageBuffer, emoji);
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ
    await ctx.telegram.deleteMessage(ctx.chat.id, processingMsg.message_id);
    
  } catch (error) {
    console.error('Error processing photo:', error);
    ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.');
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² (Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹)
bot.on('document', async (ctx) => {
  try {
    const document = ctx.message.document;
    const mimeType = document.mime_type;
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
    if (!mimeType || !mimeType.startsWith('image/')) {
      return ctx.reply('âš ï¸ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ (PNG, JPEG, WebP)');
    }
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð° (Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 5 ÐœÐ‘)
    if (document.file_size > 5 * 1024 * 1024) {
      return ctx.reply('âš ï¸ Ð¤Ð°Ð¹Ð» ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹. ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€: 5 ÐœÐ‘');
    }
    
    const emoji = ctx.message.caption || 'ðŸ˜€';
    const processingMsg = await ctx.reply('ðŸ”„ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ...');
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
    const fileLink = await ctx.telegram.getFileLink(document.file_id);
    
    // Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
    const response = await fetch(fileLink.href);
    const imageBuffer = await response.buffer();
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ð¸ÐºÐµÑ€
    await createSticker(ctx, imageBuffer, emoji);
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ
    await ctx.telegram.deleteMessage(ctx.chat.id, processingMsg.message_id);
    
  } catch (error) {
    console.error('Error processing document:', error);
    ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ.');
  }
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /sticker Ð´Ð»Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð¹ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸
bot.command('sticker', async (ctx) => {
  ctx.reply('ðŸ“¸ ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¼Ð½Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ, Ð¸ Ñ Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‰Ñƒ ÐµÐ³Ð¾ Ð² ÑÑ‚Ð¸ÐºÐµÑ€!');
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÑ‚Ð¸ÐºÐµÑ€Ð°
async function createSticker(ctx, imageBuffer, emoji) {
  try {
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ ÑÑ‚Ð¸ÐºÐµÑ€
    const form = new FormData();
    form.append('sticker', imageBuffer, { filename: 'sticker.png' });
    form.append('emoji_list', JSON.stringify([emoji]));
    
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ createNewStickerSet Ð¸Ð»Ð¸ addStickerToSet
    // Ð’ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¾Ð³Ð¾, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑƒÐ¶Ðµ Ð½Ð°Ð±Ð¾Ñ€ ÑÑ‚Ð¸ÐºÐµÑ€Ð¾Ð²
    
    // Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ‚Ñ‹ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð¸ÐºÐµÑ€ Ð² ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¼ Ð½Ð°Ð±Ð¾Ñ€Ðµ
    // Ð¸Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ðº Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
    
    // ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´: Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ°Ðº Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚
    await ctx.replyWithSticker({ source: imageBuffer });
    
  } catch (error) {
    console.error('Error creating sticker:', error);
    
    // Ð•ÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÑ‚Ð¸ÐºÐµÑ€, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
    await ctx.replyWithPhoto({ source: imageBuffer });
    ctx.reply('âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÑ‚Ð¸ÐºÐµÑ€. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ.');
  }
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error(`Error for ${ctx.updateType}:`, err);
  ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð½ÐµÐ¿Ñ€ÐµÐ´Ð²Ð¸Ð´ÐµÐ½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°.');
});

// Webhook Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ Vercel
module.exports = async (req, res) => {
  try {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¼ÐµÑ‚Ð¾Ð´ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    if (req.method === 'POST') {
      // ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ñ‚ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
      const body = req.body || {};
      
      // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
      await bot.handleUpdate(body);
      
      res.status(200).json({ ok: true });
    } else if (req.method === 'GET') {
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸
      res.status(200).json({
        status: 'Bot is running',
        timestamp: new Date().toISOString(),
        platform: 'Vercel Node.js'
      });
    } else {
      res.status(405).json({ error: 'Method not allowed' });
    }
  } catch (error) {
    console.error('Webhook error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
};

// Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº (Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸)
if (process.env.NODE_ENV === 'development') {
  bot.launch().then(() => {
    console.log('Bot is running in development mode');
  });
}
