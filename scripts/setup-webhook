#!/usr/bin/env node

import TelegramBot from 'node-telegram-bot-api';
import dotenv from 'dotenv';
import { validateBotToken } from '../lib/utils.js';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const VERCEL_URL = process.env.VERCEL_URL || 'https://telegram-sticker-bot.vercel.app';
const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET || 'sticker-bot-secret-2024';
const WEBHOOK_URL = `${VERCEL_URL}/api/bot?secret=${WEBHOOK_SECRET}`;

if (!BOT_TOKEN) {
  console.error('‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
  console.log('\nüìù –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω:');
  console.log('1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather');
  console.log('2. –î–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Vercel');
  console.log('3. –§–æ—Ä–º–∞—Ç: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz');
  process.exit(1);
}

if (!validateBotToken(BOT_TOKEN)) {
  console.error('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ Telegram Bot');
  process.exit(1);
}

async function setupWebhook() {
  console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –¥–ª—è Telegram –±–æ—Ç–∞\n');
  console.log(`üåê Vercel URL: ${VERCEL_URL}`);
  console.log(`üîó Webhook URL: ${WEBHOOK_URL}`);
  console.log(`üîë Secret: ${WEBHOOK_SECRET}\n`);
  
  try {
    const bot = new TelegramBot(BOT_TOKEN);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    const botInfo = await bot.getMe();
    console.log(`ü§ñ –ë–æ—Ç: @${botInfo.username} (${botInfo.first_name})`);
    console.log(`üÜî ID: ${botInfo.id}`);
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ–±—Ö—É–∫–µ
    const currentWebhook = await bot.getWebHookInfo();
    console.log('\nüìä –¢–µ–∫—É—â–∏–π –≤–µ–±—Ö—É–∫:');
    console.log(`URL: ${currentWebhook.url || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
    console.log(`–û—à–∏–±–æ–∫: ${currentWebhook.pending_update_count || 0}`);
    
    if (currentWebhook.url === WEBHOOK_URL) {
      console.log('\n‚úÖ –í–µ–±—Ö—É–∫ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
    } else {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –≤–µ–±—Ö—É–∫
      console.log('\nüîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –≤–µ–±—Ö—É–∫–∞...');
      await bot.setWebHook(WEBHOOK_URL, {
        max_connections: 40,
        allowed_updates: ['message', 'callback_query']
      });
      
      console.log('‚úÖ –í–µ–±—Ö—É–∫ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
      const newWebhook = await bot.getWebHookInfo();
      console.log(`\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞: ${newWebhook.url ? '‚úÖ' : '‚ùå'}`);
      console.log(`–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${newWebhook.last_error_date ? new Date(newWebhook.last_error_date * 1000) : '–ù–µ—Ç'}`);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
    console.log('\nüîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞...');
    await bot.setMyCommands([
      { command: 'start', description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞' },
      { command: 'help', description: '–°–ø—Ä–∞–≤–∫–∞' },
      { command: 'status', description: '–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã' },
      { command: 'stats', description: '–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' }
    ]);
    console.log('‚úÖ –ö–æ–º–∞–Ω–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
    
    console.log('\nüéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
    console.log(`\nüì± –¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π—Ç–µ Telegram: https://t.me/${botInfo.username}`);
    console.log(`üîß –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${VERCEL_URL}/api/setup-webhook`);
    
  } catch (err) {
    console.error(`\n‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ${err.message}`);
    
    if (err.response) {
      console.log(`–ö–æ–¥ –æ—à–∏–±–∫–∏: ${err.response.statusCode}`);
      console.log(`–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞: ${JSON.stringify(err.response.body)}`);
    }
    
    process.exit(1);
  }
}

// –ó–∞–ø—É—Å–∫
setupWebhook();
