// üîó –ù–ê–°–¢–†–û–ô–ö–ê –í–ï–ë–•–£–ö–ê –î–õ–Ø TELEGRAM

const axios = require('axios');

async function setupWebhook() {
  // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  const BOT_TOKEN = process.env.BOT_TOKEN;
  const VERCEL_URL = process.env.VERCEL_URL;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
  if (!BOT_TOKEN) {
    console.error('‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    console.log('üí° –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é BOT_TOKEN –≤ Vercel');
    process.exit(1);
  }

  if (!VERCEL_URL) {
    console.error('‚ùå –û–®–ò–ë–ö–ê: VERCEL_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    console.log('üí° –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é VERCEL_URL –≤ Vercel');
    process.exit(1);
  }

  // URL –¥–ª—è –≤–µ–±—Ö—É–∫–∞
  const webhookUrl = `${VERCEL_URL}/api/bot`;

  console.log('üîÑ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é –≤–µ–±—Ö—É–∫...');
  console.log(`ü§ñ –ë–æ—Ç: ${BOT_TOKEN.substring(0, 10)}...`);
  console.log(`üåê URL: ${webhookUrl}`);

  try {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ–±—Ö—É–∫
    const response = await axios.post(
      `https://api.telegram.org/bot${BOT_TOKEN}/setWebhook`,
      {
        url: webhookUrl,
        max_connections: 40,
        allowed_updates: ['message']
      }
    );

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (response.data.ok) {
      console.log('‚úÖ –í–ï–ë–•–£–ö –£–°–ü–ï–®–ù–û –ù–ê–°–¢–†–û–ï–ù!');
      console.log(`üìù –í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${webhookUrl}`);
    } else {
      console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞:', response.data.description);
    }

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.response?.data || error.message);
    console.log('üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:');
    console.log('   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å BOT_TOKEN');
    console.log('   - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Vercel URL');
    console.log('   - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
  }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Ñ–∞–π–ª –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é
if (require.main === module) {
  setupWebhook();
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö
module.exports = setupWebhook;
