#!/usr/bin/env node

import TelegramBot from 'node-telegram-bot-api';
import dotenv from 'dotenv';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, —á—Ç–æ–±—ã –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å utils)
function validateBotToken(token) {
  const tokenRegex = /^\d{9,11}:[A-Za-z0-9_-]{35}$/;
  return tokenRegex.test(token);
}

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const VERCEL_URL = process.env.VERCEL_URL || 'https://telegram-sticker-bot.vercel.app';
const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET || 'sticker-bot-secret-' + Date.now();
const WEBHOOK_URL = `${VERCEL_URL}/api/bot?secret=${WEBHOOK_SECRET}`;

if (!BOT_TOKEN) {
  console.error('‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
  console.log('\nüìù –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω:');
  console.log('1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather');
  console.log('2. –î–æ–±–∞–≤—å—Ç–µ –≤ .env —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Vercel');
  console.log('3. –§–æ—Ä–º–∞—Ç: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz');
  console.log('');
  console.log('üìÅ –§–∞–π–ª .env.example:');
  console.log('TELEGRAM_BOT_TOKEN=your_bot_token_here');
  console.log('VERCEL_URL=https://your-project.vercel.app');
  console.log('WEBHOOK_SECRET=your_secret_here');
  process.exit(1);
}

if (!validateBotToken(BOT_TOKEN)) {
  console.error('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ Telegram Bot');
  console.log('–¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–∞: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz');
  console.log('–í–∞—à —Ç–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤):', BOT_TOKEN.substring(0, 20) + '...');
  process.exit(1);
}

async function setupWebhook() {
  console.log('üîß ====== –ù–ê–°–¢–†–û–ô–ö–ê WEBHOOK ======\n');
  console.log(`üåê Vercel URL: ${VERCEL_URL}`);
  console.log(`üîó Webhook URL: ${WEBHOOK_URL}`);
  console.log(`üîë Secret: ${WEBHOOK_SECRET}`);
  console.log(`‚ö° Node.js: ${process.version}`);
  console.log(`üìÖ –í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}\n`);
  
  try {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
    const bot = new TelegramBot(BOT_TOKEN, {
      polling: false,
      request: {
        timeout: 10000,
        agentOptions: {
          keepAlive: true,
          maxSockets: 50
        }
      }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ
    console.log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram API...');
    const botInfo = await bot.getMe();
    console.log(`‚úÖ –ë–æ—Ç –Ω–∞–π–¥–µ–Ω: @${botInfo.username} (${botInfo.first_name})`);
    console.log(`üÜî ID –±–æ—Ç–∞: ${botInfo.id}`);
    console.log(`üîó –°—Å—ã–ª–∫–∞: https://t.me/${botInfo.username}`);
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ–±—Ö—É–∫–µ
    console.log('\nüìä –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –≤–µ–±—Ö—É–∫–µ...');
    const currentWebhook = await bot.getWebHookInfo();
    
    console.log('üìã –¢–µ–∫—É—â–∏–π –≤–µ–±—Ö—É–∫:');
    console.log(`  URL: ${currentWebhook.url || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
    console.log(`  –û—à–∏–±–æ–∫ –≤ –æ—á–µ—Ä–µ–¥–∏: ${currentWebhook.pending_update_count || 0}`);
    
    if (currentWebhook.last_error_date) {
      const errorDate = new Date(currentWebhook.last_error_date * 1000);
      console.log(`  –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${errorDate.toLocaleString('ru-RU')}`);
      console.log(`  –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: ${currentWebhook.last_error_message || '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'}`);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π –≤–µ–±—Ö—É–∫ —Å –Ω—É–∂–Ω—ã–º
    if (currentWebhook.url === WEBHOOK_URL) {
      console.log('\n‚úÖ –í–µ–±—Ö—É–∫ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
      try {
        await bot.sendMessage(botInfo.id, 
          `‚úÖ Webhook –ø—Ä–æ–≤–µ—Ä–∫–∞\n` +
          `‚è∞ ${new Date().toLocaleString('ru-RU')}\n` +
          `üåê ${VERCEL_URL}\n` +
          `‚ö° Node.js ${process.version}`,
          { parse_mode: 'HTML' }
        );
        console.log('üì® –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É');
      } catch (testError) {
        console.warn('‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', testError.message);
      }
      
    } else {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –≤–µ–±—Ö—É–∫
      console.log('\nüîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –≤–µ–±—Ö—É–∫–∞...');
      const result = await bot.setWebHook(WEBHOOK_URL, {
        max_connections: 40,
        allowed_updates: ['message', 'callback_query', 'chat_member']
      });
      
      console.log('‚úÖ –í–µ–±—Ö—É–∫ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
      console.log(`üìã –†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
      const newWebhook = await bot.getWebHookInfo();
      console.log(`\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: ${newWebhook.url ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞'}`);
      
      if (newWebhook.url) {
        console.log(`üìä –°—Ç–∞—Ç—É—Å: –í–µ–±—Ö—É–∫ –∞–∫—Ç–∏–≤–µ–Ω –Ω–∞ ${newWebhook.url}`);
      }
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
    console.log('\nüîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞...');
    await bot.setMyCommands([
      { command: 'start', description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞' },
      { command: 'help', description: '–°–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–º–æ—â—å' },
      { command: 'status', description: '–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã' },
      { command: 'stats', description: '–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' },
      { command: 'effects', description: '–î–æ—Å—Ç—É–ø–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã' }
    ]);
    console.log('‚úÖ –ö–æ–º–∞–Ω–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞
    try {
      await bot.setMyDescription({
        description: 'ü§ñ –ë–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∏–∫–µ—Ä–æ–≤ –∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π\n' +
                    'üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ ‚Üí –ü–æ–ª—É—á–∏—Ç–µ —Å—Ç–∏–∫–µ—Ä!\n' +
                    '‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã, —Ä–∞–º–∫–∏, —Ñ–∏–ª—å—Ç—Ä—ã\n' +
                    '‚ö° Node.js 24 + Vercel'
      });
      console.log('üìù –û–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
    } catch (descError) {
      console.log('üìù –û–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞ (–º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ @BotFather)');
    }
    
    console.log('\nüéâ ====== –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ======');
    console.log('');
    console.log('üì± *–î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:*');
    console.log(`1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram: https://t.me/${botInfo.username}`);
    console.log('2. –ù–∞–∂–º–∏—Ç–µ /start');
    console.log('3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è —Ç–µ—Å—Ç–∞');
    console.log('');
    console.log('üîß *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ:*');
    console.log(`‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å: ${VERCEL_URL}/api/health`);
    console.log(`‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–æ–º: ${VERCEL_URL}/api/setup-webhook`);
    console.log(`‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: ${VERCEL_URL}/`);
    console.log('');
    console.log('üìä *–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:*');
    console.log('‚Ä¢ –õ–æ–≥–∏: vercel logs <project-name>');
    console.log('‚Ä¢ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables');
    console.log('=====================================');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
    console.log('\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤...');
    
    const endpoints = [
      { name: 'Health Check', url: `${VERCEL_URL}/api/health` },
      { name: 'Webhook Setup', url: `${VERCEL_URL}/api/setup-webhook` }
    ];
    
    for (const endpoint of endpoints) {
      try {
        const response = await fetch(endpoint.url);
        console.log(`‚úÖ ${endpoint.name}: ${response.status} ${response.statusText}`);
      } catch (apiError) {
        console.log(`‚ùå ${endpoint.name}: –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω - ${apiError.message}`);
      }
    }
    
    console.log('\nüöÄ *–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:*');
    console.log('1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç–∞ –≤ Telegram');
    console.log('2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Ñ–æ—Ç–æ');
    console.log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏');
    console.log('4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)');
    console.log('');
    
    return {
      success: true,
      bot: {
        username: botInfo.username,
        name: botInfo.first_name,
        id: botInfo.id,
        link: `https://t.me/${botInfo.username}`
      },
      webhook: {
        url: WEBHOOK_URL,
        secret: WEBHOOK_SECRET,
        status: 'configured'
      },
      endpoints: {
        health: `${VERCEL_URL}/api/health`,
        webhook: `${VERCEL_URL}/api/bot`,
        dashboard: VERCEL_URL
      },
      system: {
        node_version: process.version,
        timestamp: new Date().toISOString()
      }
    };
    
  } catch (error) {
    console.error(`\n‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ${error.message}`);
    console.error(`üìã –î–µ—Ç–∞–ª–∏:`, error.stack || '–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
    
    // –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏
    if (error.response) {
      console.log(`\nüîç –û—Ç–≤–µ—Ç Telegram API:`);
      console.log(`–ö–æ–¥: ${error.response.statusCode}`);
      console.log(`–¢–µ–ª–æ: ${JSON.stringify(error.response.body)}`);
    }
    
    if (error.code === 'ETELEGRAM') {
      console.log('\n‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º–∞ —Å Telegram API:');
      console.log('1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞');
      console.log('2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      console.log('3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞ –≤ @BotFather');
    }
    
    if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {
      console.log('\nüåê –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é:');
      console.log('1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
      console.log('2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ VERCEL_URL –¥–æ—Å—Ç—É–ø–µ–Ω');
      console.log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
    }
    
    console.log('\nüîß *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é:*');
    console.log('1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TELEGRAM_BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
    console.log('2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω –≤ @BotFather');
    console.log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ VERCEL_URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –¥–æ—Å—Ç—É–ø–µ–Ω');
    console.log('4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ: npm run setup');
    
    process.exit(1);
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
const args = process.argv.slice(2);
const action = args[0] || 'setup';

if (action === '--help' || action === '-h') {
  console.log(`
üìö –ü–æ–º–æ—â—å –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤–µ–±—Ö—É–∫–∞:

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  npm run setup           # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞
  node scripts/setup-webhook.js [–æ–ø—Ü–∏–∏]

–û–ø—Ü–∏–∏:
  --help, -h             –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
  --test                 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  TELEGRAM_BOT_TOKEN     –¢–æ–∫–µ–Ω –æ—Ç @BotFather (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
  VERCEL_URL             URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Vercel
  WEBHOOK_SECRET         –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –∑–∞—â–∏—Ç—ã –≤–µ–±—Ö—É–∫–∞

–ü—Ä–∏–º–µ—Ä—ã:
  npm run setup
  TELEGRAM_BOT_TOKEN=xxx node scripts/setup-webhook.js
  `);
  process.exit(0);
}

// –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
setupWebhook();
